<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Battleship War: Strategy Panel</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        :root { --neon: #22c55e; --bg: #020617; --danger: #ef4444; --metal: #1e293b; }
        body { background: var(--bg); color: var(--neon); font-family: 'Arial Black', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; user-select: none; }
        
        /* Tactical HUD Frame */
        .hud-container { width: 1150px; height: 92vh; background: #0f172a; border: 8px solid var(--metal); margin-top: 15px; display: flex; flex-direction: column; position: relative; border-radius: 20px; box-shadow: 0 0 50px #000; }
        .main-theater { display: flex; flex: 1; padding: 20px; justify-content: space-around; gap: 20px; }

        /* Sidebar & Recycle Button */
        .sidebar { width: 200px; display: flex; flex-direction: column; align-items: center; gap: 15px; border-right: 2px solid var(--metal); padding-right: 15px; }
        .recycle-btn { width: 65px; height: 65px; cursor: pointer; transition: transform 0.4s; filter: drop-shadow(0 0 5px var(--neon)); }
        .recycle-btn:hover { transform: rotate(180deg); }
        
        .ship-item { width: 170px; padding: 12px; background: #334155; border: 2px solid var(--neon); cursor: grab; text-align: center; font-size: 11px; margin-bottom: 5px; }

        /* Grid - The "Closed" Look */
        .grid-frame { border: 5px solid var(--metal); padding: 5px; background: #000; position: relative; box-shadow: inset 0 0 20px #000; }
        .grid-box { display: grid; grid-template-columns: repeat(12, 36px); grid-template-rows: repeat(12, 36px); gap: 1px; background: #1e293b; }
        .cell { width: 36px; height: 36px; background: var(--bg); position: relative; transition: 0.2s; }
        
        /* States */
        .ship-placed { background: #475569 !important; border: 1px solid var(--neon); box-shadow: inset 0 0 8px var(--neon); }
        .hit { background: var(--danger) !important; animation: explosion 0.4s infinite alternate; }
        .miss { background: #38bdf8 !important; opacity: 0.4; }

        /* Fleet Status Bar (Bottom) */
        .fleet-status-bar { height: 130px; border-top: 5px solid var(--metal); background: #020617; display: flex; justify-content: space-around; align-items: center; padding: 0 20px; }
        .fleet-group { display: flex; flex-direction: column; align-items: center; width: 48%; }
        .ship-indicator { width: 100px; height: 30px; border: 1px solid var(--neon); margin: 3px; display: flex; align-items: center; justify-content: center; font-size: 9px; clip-path: polygon(10% 0, 90% 0, 100% 100%, 0% 100%); transition: 0.5s; }
        .is-sunk { background: var(--danger) !important; color: white; transform: scale(0.9); }

        /* Win Overlay */
        #win-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 999; }
        .win-card { border: 10px solid var(--neon); padding: 60px; text-align: center; background: #000; box-shadow: 0 0 80px var(--neon); }

        .btn-action { background: #f59e0b; color: #000; padding: 15px; width: 100%; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; }
        .btn-action:hover { background: #fbbf24; }

        @keyframes explosion { 0% { transform: scale(1); } 100% { transform: scale(1.2); box-shadow: 0 0 15px orange; } }
    </style>
</head>
<body>

<div id="win-overlay">
    <div class="win-card">
        <h1 style="font-size: 120px; margin: 0; color: var(--neon);">YOU WIN</h1>
        <p style="letter-spacing: 5px;">MISSION ACCOMPLISHED</p>
        <button onclick="location.reload()" class="btn-action" style="width: auto; padding: 15px 60px;">RE-DEPLOY FLEET</button>
    </div>
</div>

<div class="hud-container">
    <div class="main-theater">
        <div class="sidebar">
            <img src="https://cdn-icons-png.flaticon.com/512/158/158718.png" id="rot-icon" class="recycle-btn" title="Rotate BEFORE drag">
            <p style="font-size: 10px; margin-bottom: 20px;">ROTATION: <span id="rot-text">HORIZ</span></p>
            
            <div id="hangar">
                <div class="ship-item" draggable="true" id="s0">CARRIER (4x2)</div>
                <div class="ship-item" draggable="true" id="s1">DREADNOUGHT (6x1)</div>
                <div class="ship-item" draggable="true" id="s2">SUBMARINE (3x1)</div>
                <div class="ship-item" draggable="true" id="s3">BATTLESHIP A (5x1)</div>
                <div class="ship-item" draggable="true" id="s4">BATTLESHIP B (5x1)</div>
            </div>
            
            <button id="engage-btn" class="btn-action" style="display:none;">LOCK IN & ENGAGE</button>
        </div>

        <div class="grid-frame">
            <div id="p-grid" class="grid-box"></div>
            <p style="text-align:center; font-size:11px; color: #64748b;">TACTICAL PLACEMENT GRID</p>
        </div>

        <div id="enemy-radar" class="grid-frame" style="opacity: 0.1; pointer-events: none;">
            <div id="e-grid" class="grid-box"></div>
            <p style="text-align:center; font-size:11px; color: #64748b;">ENEMY RADAR (OFFLINE)</p>
        </div>
    </div>

    <div class="fleet-status-bar">
        <div class="fleet-group">
            <p style="font-size: 10px; color: var(--neon);">BLUE FLEET STATUS</p>
            <div style="display: flex; gap: 10px;" id="p-status"></div>
        </div>
        <div class="fleet-group">
            <p style="font-size: 10px; color: var(--danger);">RED FLEET STATUS</p>
            <div style="display: flex; gap: 10px;" id="e-status"></div>
        </div>
    </div>
</div>

<script type="py">
from pyscript import document, window
import random

SHIP_CONFIGS = [
    {"id": 0, "name": "CARRIER", "size": (4, 2)},
    {"id": 1, "name": "DREADNOUGHT", "size": (6, 1)},
    {"id": 2, "name": "SUBMARINE", "size": (3, 1)},
    {"id": 3, "name": "BATTLESHIP A", "size": (5, 1)},
    {"id": 4, "name": "BATTLESHIP B", "size": (5, 1)}
]

p_ships, e_ships = [], []
is_horiz = True
game_live = False

def init():
    # Grid Construction
    for g in ["p", "e"]:
        cont = document.getElementById(f"{g}-grid")
        for r in range(12):
            for c in range(12):
                cell = document.createElement("div")
                cell.className = "cell"
                cell.id = f"{g}-{r}-{c}"
                if g == "p":
                    cell.ondragover = lambda e: e.preventDefault()
                    cell.ondrop = lambda e, row=r, col=c: handle_ship_drop(e, row, col)
                else:
                    cell.onclick = lambda e, row=r, col=c: fire_missile(row, col)
                cont.appendChild(cell)

    # Status Bar Construction
    for fleet in ["p", "e"]:
        container = document.getElementById(f"{fleet}-status")
        for s in SHIP_CONFIGS:
            icon = document.createElement("div")
            icon.className = "ship-indicator"
            icon.id = f"{fleet}-ind-{s['id']}"
            icon.innerText = s["name"]
            container.appendChild(icon)
    
    cpu_placement_logic()

def handle_ship_drop(e, r, c):
    s_id = int(e.dataTransfer.getData("text"))
    spec = SHIP_CONFIGS[s_id]
    w, h = spec["size"] if is_horiz else (spec["size"][1], spec["size"][0])
    
    if r + h <= 12 and c + w <= 12:
        new_coords = set((r+i, c+j) for i in range(h) for j in range(w))
        
        # Remove existing instance of this ship to allow re-placement
        global p_ships
        p_ships = [s for s in p_ships if s['id'] != s_id]
        
        # Collision check
        if any(new_coords & s["coords"] for s in p_ships): return
        
        # Visual Update
        for cell in document.querySelectorAll("#p-grid .cell"): 
            cell.classList.remove("ship-placed")
        
        p_ships.append({"id": s_id, "coords": new_coords, "hp": len(new_coords)})
        
        for ship in p_ships:
            for pr, pc in ship["coords"]:
                document.getElementById(f"p-{pr}-{pc}").classList.add("ship-placed")
        
        if len(p_ships) == 5:
            document.getElementById("engage-btn").style.display = "block"

def fire_missile(r, c):
    if not game_live: return
    cell = document.getElementById(f"e-{r}-{c}")
    if "hit" in cell.className or "miss" in cell.className: return
    
    hit = False
    for s in e_ships:
        if (r, c) in s["coords"]:
            cell.classList.add("hit")
            s["hp"] -= 1
            hit = True
            if s["hp"] == 0:
                document.getElementById(f"e-ind-{s['id']}").classList.add("is-sunk")
                check_end_condition()
            break
    if not hit: cell.classList.add("miss")
    
    # Computer turn-based response
    window.setTimeout(lambda: cpu_response(), 500)

def cpu_response():
    searching = True
    while searching:
        r, c = random.randint(0,11), random.randint(0,11)
        cell = document.getElementById(f"p-{r}-{c}")
        if "hit" not in cell.className and "miss" not in cell.className:
            searching = False
            hit_ship = False
            for s in p_ships:
                if (r, c) in s["coords"]:
                    cell.classList.add("hit")
                    s["hp"] -= 1
                    if s["hp"] == 0:
                        document.getElementById(f"p-ind-{s['id']}").classList.add("is-sunk")
                    hit_ship = True; break
            if not hit_ship: cell.classList.add("miss")

def cpu_placement_logic():
    for spec in SHIP_CONFIGS:
        done = False
        while not done:
            r, c, rot = random.randint(0,11), random.randint(0,11), random.choice([True, False])
            w, h = spec["size"] if rot else (spec["size"][1], spec["size"][0])
            if r + h <= 12 and c + w <= 12:
                coords = set((r+i, c+j) for i in range(h) for j in range(w))
                if not any(coords & s["coords"] for s in e_ships):
                    e_ships.append({"id": spec["id"], "coords": coords, "hp": len(coords)})
                    done = True

def engage_war(e):
    global game_live
    game_live = True
    document.getElementById("enemy-radar").style.opacity = "1"
    document.getElementById("enemy-radar").style.pointerEvents = "all"
    document.getElementById("hangar").style.display = "none"
    document.getElementById("engage-btn").style.display = "none"
    document.getElementById("rot-icon").style.display = "none"

def rotate_logic(e):
    global is_horiz
    is_horiz = not is_horiz
    document.getElementById("rot-text").innerText = "HORIZ" if is_horiz else "VERT"

def check_end_condition():
    if all(s["hp"] == 0 for s in e_ships):
        document.getElementById("win-overlay").style.display = "flex"

def start_drag_event(e):
    e.dataTransfer.setData("text", e.target.id[1:])

document.getElementById("rot-icon").onclick = rotate_logic
document.getElementById("engage-btn").onclick = engage_war
for i in range(5):
    document.getElementById(f"s{i}").ondragstart = start_drag_event

init()
</script>
</body>
</html>
