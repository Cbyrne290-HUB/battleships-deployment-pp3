<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Battleship War: Tactical Command</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        :root { --neon-green: #22c55e; --deep-navy: #020617; }
        body { background: var(--deep-navy); color: var(--neon-green); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        .hud { width: 1000px; margin-top: 20px; padding: 20px; border: 2px solid #1e293b; background: rgba(15, 23, 42, 0.9); position: relative; border-radius: 8px; }
        .main-layout { display: flex; justify-content: space-between; gap: 20px; margin-top: 20px; }

        /* Ship Hangar */
        .hangar { width: 220px; display: flex; flex-direction: column; gap: 10px; border: 1px dashed #334155; padding: 10px; }
        .drag-ship { 
            background: rgba(34, 197, 94, 0.1); border: 1px solid var(--neon-green); 
            cursor: grab; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;
        }

        /* Tactical Grids */
        .grid-frame { display: flex; flex-direction: column; align-items: center; }
        .grid { display: grid; grid-template-columns: 30px repeat(12, 32px); gap: 1px; background: var(--neon-green); border: 1px solid var(--neon-green); }
        .cell { width: 32px; height: 32px; background: var(--deep-navy); position: relative; cursor: crosshair; }
        .label { background: #0f172a; color: var(--neon-green); font-size: 10px; display: flex; align-items: center; justify-content: center; }

        /* Ship Visuals & Effects */
        .placed { background: #475569 !important; border: 1px solid #94a3b8; }
        .hit { background: #ef4444 !important; }
        .miss { background: #38bdf8 !important; opacity: 0.3; }
        
        /* Command Buttons (Right Side) */
        .controls-sidebar { display: flex; flex-direction: column; gap: 15px; }
        .cmd-btn { 
            width: 60px; height: 60px; border: 2px solid var(--neon-green); 
            background: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px;
        }
        .cmd-btn:hover { background: var(--neon-green); color: #000; }
        .play-btn { background: #16a34a; color: white; border: none; font-size: 30px; display: none; }

        /* Win Screen Overlay */
        #win-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
        }
        .win-card { border: 4px solid var(--neon-green); padding: 50px; text-align: center; box-shadow: 0 0 40px var(--neon-green); }

        @keyframes explode { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }
        .boom { position: absolute; width: 100%; height: 100%; background: orange; border-radius: 50%; animation: explode 0.5s ease-out; }
    </style>
</head>
<body>

<div id="win-overlay">
    <div class="win-card">
        <h1 style="font-size: 60px; margin: 0;">YOU WIN</h1>
        <p id="final-score">SCORE: 1245</p>
        <button onclick="location.reload()" style="padding: 10px 20px; cursor: pointer; background: var(--neon-green); border: none; font-weight: bold;">NEW MISSION</button>
    </div>
</div>

<div class="hud">
    <h2 style="text-align: center; margin: 0;">STRATEGY PANEL: BATTLESHIP WAR</h2>
    <div id="status-bar" style="text-align: center; color: #fb923c; margin: 10px;">DEPLOY YOUR FLEET TO THE TACTICAL GRID</div>

    <div class="main-layout">
        <div class="hangar" id="hangar">
            <div class="drag-ship" draggable="true" id="s-0" style="width:128px; height:64px;">CARRIER (4x2)</div>
            <div class="drag-ship" draggable="true" id="s-1" style="width:192px; height:32px;">DREADNOUGHT (6x1)</div>
            <div class="drag-ship" draggable="true" id="s-2" style="width:96px; height:32px;">SUBMARINE (3x1)</div>
            <div class="drag-ship" draggable="true" id="s-3" style="width:160px; height:32px;">FRIGATE (5x1)</div>
        </div>

        <div class="grid-frame">
            <div id="p-grid" class="grid"></div>
            <p>YOUR TACTICAL GRID (A1-L12)</p>
        </div>

        <div class="grid-frame" id="enemy-radar-container" style="display:none;">
            <div id="e-grid" class="grid"></div>
            <p>ENEMY RADAR</p>
        </div>

        <div class="controls-sidebar">
            <div class="cmd-btn" id="rot-btn" onclick="rotate_current()" title="Rotate">üîÑ</div>
            <div class="cmd-btn" onclick="location.reload()" title="Reset">üóëÔ∏è</div>
            <div class="cmd-btn" id="shuffle-btn" onclick="shuffle_ships()" title="Shuffle">üîÄ</div>
            <button class="cmd-btn play-btn" id="start-btn" onclick="start_battle()">‚ñ∂</button>
        </div>
    </div>
</div>

<script type="py">
from pyscript import document, window
import random

# Config
SHIP_SPECS = [
    {"id": 0, "name": "CARRIER", "size": (4, 2)},
    {"id": 1, "name": "DREADNOUGHT", "size": (6, 1)},
    {"id": 2, "name": "SUBMARINE", "size": (3, 1)},
    {"id": 3, "name": "FRIGATE", "size": (5, 1)}
]
GRID_SIZE = 12
player_fleet = []
enemy_fleet = []
is_horiz = True

def init_game():
    for g_id in ["p-grid", "e-grid"]:
        grid = document.getElementById(g_id)
        # Headers
        grid.appendChild(create_cell("", "label"))
        for i in range(1, GRID_SIZE+1): grid.appendChild(create_cell(str(i), "label"))
        # Rows
        for r in range(GRID_SIZE):
            grid.appendChild(create_cell(chr(65+r), "label"))
            for c in range(GRID_SIZE):
                cell = create_cell("", "cell")
                cell.id = f"{g_id[0]}-{r}-{c}"
                if g_id == "p-grid":
                    cell.ondragover = lambda e: e.preventDefault()
                    cell.ondrop = lambda e, row=r, col=c: handle_drop(e, row, col)
                else:
                    cell.onclick = lambda e, row=r, col=c: player_attack(row, col)
                grid.appendChild(cell)
    spawn_enemy_fleet()

def create_cell(text, cls):
    d = document.createElement("div")
    d.className = f"cell {cls}"
    d.innerText = text
    return d

def handle_drop(event, r, c):
    ship_id = int(event.dataTransfer.getData("text"))
    spec = SHIP_SPECS[ship_id]
    w, h = spec["size"] if is_horiz else (spec["size"][1], spec["size"][0])
    
    if r + h <= GRID_SIZE and c + w <= GRID_SIZE:
        coords = set((r+i, c+j) for i in range(h) for j in range(w))
        if any(coords & s["coords"] for s in player_fleet): return
        
        for row, col in coords:
            document.getElementById(f"p-{row}-{col}").classList.add("placed")
        
        player_fleet.append({"name": spec["name"], "coords": coords, "hp": len(coords)})
        document.getElementById(f"s-{ship_id}").style.opacity = "0.2"
        document.getElementById(f"s-{ship_id}").draggable = False
        
        if len(player_fleet) == len(SHIP_SPECS):
            document.getElementById("start-btn").style.display = "flex"
            document.getElementById("status-bar").innerText = "FLEET READY. PRESS PLAY TO ENGAGE."

def spawn_enemy_fleet():
    for spec in SHIP_SPECS:
        placed = False
        while not placed:
            r, c = random.randint(0, 11), random.randint(0, 11)
            rot = random.choice([True, False])
            w, h = spec["size"] if rot else (spec["size"][1], spec["size"][0])
            if r + h <= GRID_SIZE and c + w <= GRID_SIZE:
                coords = set((r+i, c+j) for i in range(h) for j in range(w))
                if not any(coords & s["coords"] for s in enemy_fleet):
                    enemy_fleet.append({"name": spec["name"], "coords": coords, "hp": len(coords)})
                    placed = True

def player_attack(r, c):
    cell = document.getElementById(f"e-{r}-{c}")
    if "hit" in cell.className or "miss" in cell.className: return
    
    hit = False
    for ship in enemy_fleet:
        if (r, c) in ship["coords"]:
            cell.classList.add("hit")
            ship["hp"] -= 1
            hit = True
            if all(s["hp"] == 0 for s in enemy_fleet):
                document.getElementById("win-overlay").style.display = "flex"
            break
    if not hit: cell.classList.add("miss")

def rotate_current(event=None):
    global is_horiz
    is_horiz = not is_horiz
    status = "HORIZONTAL" if is_horiz else "VERTICAL"
    document.getElementById("status-bar").innerText = f"ROTATION SET TO: {status}"

def start_battle(event=None):
    document.getElementById("enemy-radar-container").style.display = "flex"
    document.getElementById("hangar").style.display = "none"
    document.getElementById("status-bar").innerText = "BATTLE COMMENCED: TARGET THE ENEMY RADAR"

# JS Bridge
def on_drag_start(event):
    event.dataTransfer.setData("text", event.target.id.split("-")[1])

window.on_drag_start = on_drag_start
window.rotate_current = rotate_current
window.start_battle = start_battle

init_game()
for i in range(len(SHIP_SPECS)):
    document.getElementById(f"s-{i}").ondragstart = on_drag_start
</script>
</body>
</html>
