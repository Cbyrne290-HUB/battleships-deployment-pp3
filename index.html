<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Battleship War: Tactical Command</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        :root { --neon: #22c55e; --bg: #020617; --danger: #ef4444; --metal: #1e293b; }
        body { background: #000; color: var(--neon); font-family: 'Courier New', monospace; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        
        .hud-frame { width: 1200px; height: 850px; background: radial-gradient(circle, #0f172a 0%, #020617 100%); border: 2px solid #334155; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 50px #000; }
        .header { height: 50px; border-bottom: 1px solid var(--metal); display: flex; align-items: center; justify-content: center; letter-spacing: 8px; background: rgba(0,0,0,0.6); font-weight: bold; }

        .theater { display: flex; flex: 1; padding: 25px; gap: 30px; }

        /* Left Sidebar */
        .sidebar { width: 220px; display: flex; flex-direction: column; gap: 12px; border-right: 1px solid var(--metal); padding-right: 20px; }
        .ship-btn { background: rgba(30, 41, 59, 0.7); border: 1px solid var(--neon); color: var(--neon); padding: 12px; cursor: grab; font-size: 11px; transition: 0.2s; }
        .ship-btn:hover { background: var(--neon); color: #000; }
        .ship-btn.deployed { opacity: 0.3; cursor: default; }

        /* Grids */
        .grid-container { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .grid { display: grid; grid-template-columns: repeat(12, 38px); grid-template-rows: repeat(12, 38px); background: rgba(34, 197, 94, 0.05); border: 2px solid var(--neon); box-shadow: 0 0 15px rgba(34, 197, 94, 0.2); }
        .cell { width: 38px; height: 38px; border: 1px solid rgba(34, 197, 94, 0.1); box-sizing: border-box; }
        
        /* Placement Effects */
        .ghost-valid { background: rgba(34, 197, 94, 0.4) !important; }
        .ghost-invalid { background: rgba(239, 68, 68, 0.4) !important; }
        .placed { background: #475569; border: 1px solid var(--neon); box-shadow: inset 0 0 10px var(--neon); }
        .hit { background: var(--danger) !important; animation: blink 0.5s infinite; }
        .miss { background: #38bdf8; opacity: 0.3; }

        /* Bottom Status */
        .status-bar { height: 110px; border-top: 1px solid var(--metal); display: flex; justify-content: space-around; align-items: center; background: rgba(0,0,0,0.8); }
        .ship-tag { width: 80px; height: 25px; border: 1px solid var(--neon); font-size: 9px; display: flex; align-items: center; justify-content: center; }
        .sunk { background: var(--danger); color: white; border-color: var(--danger); }

        .btn-lock { background: #f59e0b; color: #000; padding: 15px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-top: auto; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="hud-frame">
    <div class="header">STRATEGY PANEL: 12x12 COMMAND</div>
    
    <div class="theater">
        <div class="sidebar">
            <div style="font-size: 10px; color: #64748b; text-align: center;">RIGHT-CLICK PLACED SHIPS TO ROTATE</div>
            <div id="hangar" style="display:contents;">
                <div class="ship-btn" draggable="true" id="s0" data-id="0">CARRIER (4x2)</div>
                <div class="ship-btn" draggable="true" id="s1" data-id="1">DREADNOUGHT (6x1)</div>
                <div class="ship-btn" draggable="true" id="s2" data-id="2">SUBMARINE (3x1)</div>
                <div class="ship-btn" draggable="true" id="s3" data-id="3">BATTLESHIP A (5x1)</div>
                <div class="ship-btn" draggable="true" id="s4" data-id="4">BATTLESHIP B (5x1)</div>
            </div>
            <button id="lock-btn" class="btn-lock" style="display:none;">LOCK IN & ENGAGE</button>
        </div>

        <div class="grid-container">
            <span style="font-size: 10px;">TACTICAL PLACEMENT</span>
            <div id="p-grid" class="grid"></div>
        </div>

        <div class="grid-container" id="enemy-radar" style="opacity: 0.1; pointer-events: none;">
            <span style="font-size: 10px;">ENEMY RADAR</span>
            <div id="e-grid" class="grid"></div>
        </div>
    </div>

    <div class="status-bar">
        <div id="p-status" style="display:flex; gap:10px;"></div>
        <div id="e-status" style="display:flex; gap:10px;"></div>
    </div>
</div>

<script type="py">
from pyscript import document, window
import random

SHIP_DATA = [
    {"id": 0, "name": "CARRIER", "w": 4, "h": 2},
    {"id": 1, "name": "DREAD", "w": 6, "h": 1},
    {"id": 2, "name": "SUB", "w": 3, "h": 1},
    {"id": 3, "name": "BATTLE-A", "w": 5, "h": 1},
    {"id": 4, "name": "BATTLE-B", "w": 5, "h": 1}
]

p_fleet = {}
e_fleet = []
is_horiz = True
battle_mode = False
current_drag_id = None

def init():
    # Grid Logic (12x12)
    for g in ["p", "e"]:
        cont = document.getElementById(f"{g}-grid")
        for r in range(12):
            for c in range(12):
                cell = document.createElement("div")
                cell.className = "cell"
                cell.id = f"{g}-{r}-{c}"
                if g == "p":
                    cell.ondragover = lambda e, row=r, col=c: handle_drag_over(e, row, col)
                    cell.ondragleave = lambda e: clear_ghosts()
                    cell.ondrop = lambda e, row=r, col=c: handle_drop(e, row, col)
                else:
                    cell.onclick = lambda e, row=r, col=c: handle_click(row, col)
                cont.appendChild(cell)

    # Status Bar
    for fleet in ["p", "e"]:
        bar = document.getElementById(f"{fleet}-status")
        for s in SHIP_DATA:
            d = document.createElement("div")
            d.className = "ship-tag"
            d.id = f"{fleet}-tag-{s['id']}"
            d.innerText = s["name"]
            bar.appendChild(d)
    cpu_place()

def handle_drag_over(e, r, c):
    e.preventDefault()
    if current_drag_id is None: return
    
    clear_ghosts()
    spec = SHIP_DATA[int(current_drag_id)]
    w, h = (spec["w"], spec["h"]) if is_horiz else (spec["h"], spec["w"])
    
    valid = True
    if r + h > 12 or c + w > 12: valid = False
    
    coords = []
    if valid:
        coords = [(r+i, c+j) for i in range(h) for j in range(w)]
        # Check collision with other ships
        for sid, data in p_fleet.items():
            if sid != int(current_drag_id) and any(tuple(coord) in data["coords"] for coord in coords):
                valid = False
    
    # Draw Ghost
    if valid:
        for gr, gc in coords:
            document.getElementById(f"p-{gr}-{gc}").classList.add("ghost-valid")
    else:
        document.getElementById(f"p-{r}-{c}").classList.add("ghost-invalid")

def clear_ghosts():
    for cell in document.querySelectorAll(".cell"):
        cell.classList.remove("ghost-valid", "ghost-invalid")

def handle_drop(e, r, c):
    clear_ghosts()
    s_id = int(e.dataTransfer.getData("text"))
    spec = SHIP_DATA[s_id]
    w, h = (spec["w"], spec["h"]) if is_horiz else (spec["h"], spec["w"])
    
    if r + h <= 12 and c + w <= 12:
        new_coords = set((r+i, c+j) for i in range(h) for j in range(w))
        if any(new_coords & s["coords"] for sid, s in p_fleet.items() if sid != s_id): return
        
        # Remove old visual
        for cell in document.querySelectorAll(".placed"):
            # This is a bit brute force but ensures clean updates
            cell.classList.remove("placed")
            cell.oncontextmenu = None

        p_fleet[s_id] = {"coords": new_coords, "hp": len(new_coords), "r": r, "c": c, "w": w, "h": h}
        
        # Re-render all placed
        for sid, data in p_fleet.items():
            for pr, pc in data["coords"]:
                cell = document.getElementById(f"p-{pr}-{pc}")
                cell.classList.add("placed")
                cell.oncontextmenu = lambda e, id=sid: rotate_placed(e, id)

        if len(p_fleet) == 5:
            document.getElementById("lock-btn").style.display = "block"

def rotate_placed(e, s_id):
    e.preventDefault()
    if battle_mode: return
    ship = p_fleet[s_id]
    # Simple logic: flip orientation and re-trigger a "drop" at same spot
    global is_horiz
    is_horiz = not is_horiz
    # We simulate a drop to validate the new rotation
    # If invalid, it just won't update
    handle_drop_simulated(s_id, ship["r"], ship["c"])

def handle_drop_simulated(s_id, r, c):
    spec = SHIP_DATA[s_id]
    w, h = (spec["w"], spec["h"]) if is_horiz else (spec["h"], spec["w"])
    if r + h <= 12 and c + w <= 12:
        new_coords = set((r+i, c+j) for i in range(h) for j in range(w))
        if not any(new_coords & s["coords"] for sid, s in p_fleet.items() if sid != s_id):
            p_fleet[s_id] = {"coords": new_coords, "hp": len(new_coords), "r": r, "c": c, "w": w, "h": h}
            # Clean and re-draw
            for cell in document.querySelectorAll(".placed"): cell.classList.remove("placed")
            for sid, data in p_fleet.items():
                for pr, pc in data["coords"]: document.getElementById(f"p-{pr}-{pc}").classList.add("placed")

def handle_click(r, c):
    if not battle_mode: return
    cell = document.getElementById(f"e-{r}-{c}")
    if "hit" in cell.className or "miss" in cell.className: return
    
    hit = False
    for s in e_fleet:
        if (r, c) in s["coords"]:
            cell.classList.add("hit")
            s["hp"] -= 1
            hit = True
            if s["hp"] == 0: document.getElementById(f"e-tag-{s['id']}").classList.add("sunk")
            break
    if not hit: cell.classList.add("miss")
    window.setTimeout(lambda: cpu_turn(), 500)

def cpu_turn():
    target = False
    while not target:
        r, c = random.randint(0,11), random.randint(0,11)
        cell = document.getElementById(f"p-{r}-{c}")
        if "hit" not in cell.className and "miss" not in cell.className:
            target = True
            hit = False
            for sid, s in p_fleet.items():
                if (r, c) in s["coords"]:
                    cell.classList.add("hit")
                    s["hp"] -= 1
                    if s["hp"] == 0: document.getElementById(f"p-tag-{sid}").classList.add("sunk")
                    hit = True; break
            if not hit: cell.classList.add("miss")

def cpu_place():
    for spec in SHIP_DATA:
        placed = False
        while not placed:
            r, c, rot = random.randint(0,11), random.randint(0,11), random.choice([True, False])
            w, h = (spec["w"], spec["h"]) if rot else (spec["h"], spec["w"])
            if r+h <= 12 and c+w <= 12:
                coords = set((r+i, c+j) for i in range(h) for j in range(w))
                if not any(coords & s["coords"] for s in e_fleet):
                    e_fleet.append({"id": spec["id"], "coords": coords, "hp": len(coords)})
                    placed = True

def engage(e):
    global battle_mode
    battle_mode = True
    document.getElementById("enemy-radar").style.opacity = "1"
    document.getElementById("enemy-radar").style.pointerEvents = "all"
    document.getElementById("lock-btn").style.display = "none"
    document.getElementById("hangar").style.opacity = "0.2"

def start_drag(e):
    global current_drag_id
    current_drag_id = e.target.dataset.id
    e.dataTransfer.setData("text", current_drag_id)

document.getElementById("lock-btn").onclick = engage
for i in range(5):
    btn = document.getElementById(f"s{i}")
    btn.ondragstart = start_drag

init()
</script>
</body>
</html>
